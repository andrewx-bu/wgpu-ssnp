<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SSNP WebGPU Demo</title>
    <style>
        body {
            margin: 0;
            background-color: #202020;
            color: #eee;
            font-family: Arial, sans-serif;
        }
        h1 {
            text-align: center;
        }
        #controls {
            display: flex;
            justify-content: center;
            margin-bottom: 10px;
        }
        #viewer {
            display: flex;
            flex-direction: row;
            flex-wrap: nowrap;
            overflow-x: auto;
            padding: 10px;
            background-color: #111;
        }
        .slice-container {
            display: flex;
            flex-direction: row;
            align-items: center;
            margin-right: 20px;
        }
        canvas {
            image-rendering: pixelated;
            border: 1px solid #555;
        }
        .colorbar {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-left: 5px;
        }
        .colorbar canvas {
            width: 10px;
            height: 100%;
        }
        .colorbar-label {
            font-size: 0.75rem;
            text-align: center;
            color: #ccc;
        }
    </style>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
</head>
<body>
    <h1>SSNP Forward WebGPU Demo</h1>
    <div id="controls">
        <input type="file" id="fileInput" accept=".bin" />
        <button id="runBtn" disabled>Run Forward</button>
    </div>
    <div id="viewer"></div>

    <script>
        var Module = {
            noInitialRun: true,
            print: function (text) {
                console.log(text);
            },
        };

        function plotSlices(flatArray, D, H, W, globalMin, globalMax) {
            const viewer = document.getElementById('viewer');
            viewer.innerHTML = ''; // Clear previous output

            const scale = globalMax - globalMin || 1;

            let idx = 0;
            for (let d = 0; d < D; d++) {
                const container = document.createElement('div');
                container.className = 'slice-container';

                const canvas = document.createElement('canvas');
                canvas.width = W;
                canvas.height = H;
                const ctx = canvas.getContext('2d');
                const imgData = ctx.createImageData(W, H);

                for (let i = 0; i < H; i++) {
                    for (let j = 0; j < W; j++) {
                        const value = flatArray[idx++];
                        const norm = (value - globalMin) / scale;
                        const [r, g, b] = colormap(norm);
                        const pixelIndex = (i * W + j) * 4;
                        imgData.data[pixelIndex] = r;
                        imgData.data[pixelIndex + 1] = g;
                        imgData.data[pixelIndex + 2] = b;
                        imgData.data[pixelIndex + 3] = 255;
                    }
                }

                ctx.putImageData(imgData, 0, 0);
                container.appendChild(canvas);

                // Colorbar for this slice
                const colorbar = document.createElement('div');
                colorbar.className = 'colorbar';
                const colorCanvas = document.createElement('canvas');
                colorCanvas.width = 10;
                colorCanvas.height = H;
                const colorCtx = colorCanvas.getContext('2d');
                const colorImg = colorCtx.createImageData(1, H);

                for (let i = 0; i < H; i++) {
                    const t = 1 - i / (H - 1);
                    const [r, g, b] = colormap(t);
                    const idx2 = i * 4;
                    colorImg.data[idx2] = r;
                    colorImg.data[idx2 + 1] = g;
                    colorImg.data[idx2 + 2] = b;
                    colorImg.data[idx2 + 3] = 255;
                }
                // Stretch colorbar horizontally
                for (let x = 0; x < 10; x++) {
                    colorCtx.putImageData(colorImg, x, 0);
                }

                colorbar.appendChild(colorCanvas);
                const maxLabel = document.createElement('div');
                maxLabel.className = 'colorbar-label';
                maxLabel.textContent = globalMax.toExponential(3);  // More precise
                const minLabel = document.createElement('div');
                minLabel.className = 'colorbar-label';
                minLabel.textContent = globalMin.toExponential(3);  // More precise
                colorbar.insertBefore(maxLabel, colorCanvas);
                colorbar.appendChild(minLabel);

                container.appendChild(colorbar);
                viewer.appendChild(container);
            }
        }

        function colormap(t) {
            t = Math.max(0, Math.min(1, t));
            const c = d3.color(d3.interpolateViridis(t));
            return [c.r, c.g, c.b];
        }

        Module.onRuntimeInitialized = () => {
            const fileInput = document.getElementById("fileInput");
            const runBtn = document.getElementById("runBtn");

            fileInput.addEventListener("change", (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const r = new FileReader();
                r.onload = () => {
                    const data = new Uint8Array(r.result);
                    FS.writeFile("input.bin", data);
                    runBtn.disabled = false;
                };
                r.readAsArrayBuffer(file);
            });

            runBtn.addEventListener("click", () => {
                const viewer = document.getElementById('viewer');
                viewer.innerHTML = ''; // Clear before running
                Module.ccall(
                    "runForwardFromFile",
                    null,
                    [],
                    [],
                    { async: true }
                ).catch(err => console.error("Error:", err));
            });
        };
    </script>
    <script async src="ssnp_cpp.js"></script>
</body>
</html>
